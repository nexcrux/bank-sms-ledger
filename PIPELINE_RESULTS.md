# SAB Template Discovery - Initial Results

**Run Date:** January 31, 2026  
**Dataset:** 1,668 SAB SMS messages (1 year of data)

## Summary Statistics

- **Total Messages:** 1,668
- **Clusters Found:** 383
- **Clustering Threshold:** 0.3 (default)

## Top 10 Clusters by Message Count

1. **Cluster 279** (123 messages, 7.4%) - Login notifications (English)
   - "You are successfully logged in to SAB mobile using Face ID/Touch ID"

2. **Cluster 10** (118 messages, 7.1%) - POS purchase at Starbucks (Arabic)
   - شراء عبر نقاط البيع at Starbucks with balance

3. **Cluster 39** (117 messages, 7.0%) - Internal account transfers
   - Debit transfer between accounts

4. **Cluster 2** (109 messages, 6.5%) - Online purchases (Arabic)
   - شراء عبر الإنترنت with Mastercard Alfursan

5. **Cluster 296** (37 messages, 2.2%) - Apple Pay POS purchase (English)
   - PoS Purchase By mada(Apple Pay)

6. **Cluster 11** (35 messages, 2.1%) - POS purchase at Starbucks (variant)
   - Similar to cluster 10 but different format

7. **Cluster 14** (34 messages, 2.0%) - Online purchases (variant)
   - Similar to cluster 2 but different structure

8. **Cluster 1** (33 messages, 2.0%) - POS purchases (English)
   - PoS Purchase with credit card

9. **Cluster 0** (32 messages, 1.9%) - Online purchases (English)
   - Online Purchase By credit card

10. **Cluster 5** (31 messages, 1.9%) - OTP codes (Arabic)
    - كلمة مرور صالحة لمرة واحدة

## Analysis

### Clustering Quality

The pipeline produced **383 clusters**, which is higher than the target of 20-60 clusters. This suggests:

1. **Too granular:** The current threshold (0.3) is creating separate clusters for very similar message templates
2. **Merchant-specific clustering:** Many clusters differ only by merchant name (e.g., separate clusters for different Starbucks locations)
3. **Minor format variations:** Small differences in punctuation or wording create separate clusters

### Recommendations for Tuning

To reduce the cluster count to 20-60 templates:

#### Option 1: Increase Similarity Threshold

Edit `scripts/cluster.py` line 20:

```python
SIMILARITY_THRESHOLD = 0.5  # Try 0.4-0.6 for more aggressive merging
```

This will merge more similar skeletons together.

#### Option 2: Enhance Merchant Normalization

Add merchant name normalization to `scripts/normalize.py`:
- Replace all merchant names with `<MERCHANT>`
- This would merge clusters that differ only by merchant

#### Option 3: Two-Level Clustering

1. First level: Cluster by transaction type (purchase, transfer, OTP, login)
2. Second level: Within each type, cluster by message structure

### Message Type Distribution (Estimated from top clusters)

- **POS Purchases:** ~40% (clusters 10, 11, 296, 1, etc.)
- **Online Purchases:** ~15% (clusters 2, 14, 0, etc.)
- **Transfers:** ~10% (cluster 39, etc.)
- **Login Notifications:** ~7% (cluster 279)
- **OTP/Authentication:** ~5% (cluster 5)
- **Other:** ~23% (balance inquiries, fees, alerts, etc.)

## Next Steps

1. **Tune clustering threshold** to merge similar templates
   ```bash
   # Edit scripts/cluster.py SIMILARITY_THRESHOLD
   # Re-run clustering
   python3 scripts/cluster.py && \
   python3 scripts/generate_report.py && \
   python3 scripts/generate_templates.py
   ```

2. **Review `out/cluster_report.md`** to understand message patterns

3. **Manually review clusters** to identify which should be merged

4. **Create template groups** by message type:
   - `templates/sab/purchase_pos/`
   - `templates/sab/purchase_online/`
   - `templates/sab/transfer/`
   - `templates/sab/auth/`

5. **Build parsers** from the template files with field extraction logic

6. **Write tests** using example messages from cluster example files

## Output Files Generated

- ✓ `data/sab_messages.jsonl` (427 KB)
- ✓ `data/sab_messages_normalized.jsonl` (1.0 MB)
- ✓ `out/clusters.csv` (73 KB)
- ✓ `out/cluster_membership.csv` (25 KB)
- ✓ `out/cluster_report.md` (263 KB)
- ✓ `out/cluster_examples/` (385 files)
- ✓ `templates/sab/` (383 YAML files)

All outputs are deterministic and can be regenerated by re-running the pipeline.
